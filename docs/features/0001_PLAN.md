# Create Game Endpoint - Technical Plan

## Description

Implement the API endpoint to create a new game for a single authenticated user. The endpoint will fetch clues from the Cluebase API, construct valid Jeopardy and Double Jeopardy boards according to business rules, create the game record with associated GameClue records, and return the game object with initial score, board state, and metadata.

---

## Files to Create

### Backend Service Layer
- `backend/src/game/game.service.ts` - Core game creation logic, board construction, clue fetching
- `backend/src/game/game.module.ts` - Game module definition
- `backend/src/cluebase/cluebase.service.ts` - Cluebase API client for fetching clues
- `backend/src/cluebase/cluebase.module.ts` - Cluebase module definition

### Backend Controller Layer
- `backend/src/game/game.controller.ts` - HTTP endpoint handler for POST /games

### Types and DTOs
- `backend/src/game/dto/create-game.dto.ts` - Request DTO (empty, user ID from JWT)
- `backend/src/game/dto/game-response.dto.ts` - Response DTO with game state

---

## Files to Modify

### Backend Module Registration
- `backend/src/app.module.ts` - Import GameModule and CluebaseModule

### Configuration
- `backend/.env` (or environment variables) - Add Cluebase API base URL and any required API keys

---

## Algorithm: Game Creation Process

### Step 1: Validate User and Active Game Check
1. Extract `userId` from JWT token (authentication middleware handles this)
2. Query database for active games: `Game` where `userId = userId` and `state IN (PENDING, ACTIVE, FINAL_PENDING, FINAL_ACTIVE)`
3. If active game exists, return error (business rule: user may only have one active game at a time)

### Step 2: Fetch and Filter Clues from Cluebase API
1. Make HTTP request to Cluebase API to fetch clues
2. Filter clues to only include:
   - Clues with non-null `clue` (question) text
   - Clues with non-null `answer` (correct response) text
   - Clues with valid dollar values matching Jeopardy structure:
     - Jeopardy round: $200, $400, $600, $800, $1000
     - Double Jeopardy round: $400, $800, $1200, $1600, $2000
3. Group clues by category and round
4. Validate that sufficient clues exist to construct boards

### Step 3: Construct Jeopardy Round Board
1. Select 6 categories from available Jeopardy clues
2. For each category, select exactly 5 clues matching the dollar values: $200, $400, $600, $800, $1000
3. Verify that exactly 1 Daily Double exists in the selected clues (use `daily_double` field from Cluebase API)
4. If board cannot be constructed with exactly 1 Daily Double, fail game creation

### Step 4: Construct Double Jeopardy Round Board
1. Select 6 categories from available Double Jeopardy clues (different from Jeopardy categories)
2. For each category, select exactly 5 clues matching the dollar values: $400, $800, $1200, $1600, $2000
3. Verify that exactly 2 Daily Doubles exist in the selected clues
4. If board cannot be constructed with exactly 2 Daily Doubles, fail game creation

### Step 5: Persist Game and Clues
1. Create `Game` record:
   - `userId`: from JWT
   - `state`: `PENDING`
   - `score`: `0`
2. For each selected clue in both rounds:
   - Check if `Clue` record exists (by matching category, round, value, question, answer, dailyDouble)
   - If not exists, create new `Clue` record
   - Create `GameClue` record linking game to clue:
     - `gameId`: newly created game ID
     - `clueId`: clue ID (existing or newly created)
     - `state`: `UNANSWERED`
3. Create `GameAudit` record:
   - `gameId`: newly created game ID
   - `action`: "GAME_CREATED"
   - `details`: JSON with board composition summary

### Step 6: Return Game Response
1. Query game with all related `GameClue` records and their associated `Clue` records
2. Transform to response DTO including:
   - Game ID, state, score
   - Board structure organized by round and category
   - Clue metadata (category, value, dailyDouble status) without revealing questions/answers
   - Timestamps

---

## Business Rules Enforcement

### Rule: One Active Game Per User
- Enforced in Step 1 by querying for active games before creation
- Return HTTP 409 Conflict if active game exists

### Rule: Board Composition Requirements
- Jeopardy: 6 categories × 5 clues = 30 clues, exactly 1 Daily Double
- Double Jeopardy: 6 categories × 5 clues = 30 clues, exactly 2 Daily Doubles
- Enforced in Steps 3-4; fail game creation if requirements cannot be met

### Rule: Daily Double Assignment
- Use `daily_double` field from Cluebase API, not random assignment
- Enforced by filtering and validating during board construction

### Rule: Clue Immutability
- Clue records are never updated after creation
- Enforced by checking for existing clues before creating new ones

### Rule: Deterministic State
- All game state persisted immediately upon creation
- No transient or derived state in response

---

## Error Handling

### Cluebase API Failures
- If API request fails, return HTTP 503 Service Unavailable
- Log error details for debugging

### Insufficient Clue Data
- If cannot construct valid boards, return HTTP 422 Unprocessable Entity
- Include error message indicating which round failed and why

### Database Transaction Failures
- Wrap game creation in database transaction
- Rollback on any failure during persistence
- Return HTTP 500 Internal Server Error

### Active Game Exists
- Return HTTP 409 Conflict with message indicating user must complete or abandon existing game

---

## Dependencies

- PrismaService (already exists in `backend/src/prisma/prisma.service.ts`)
- JWT authentication middleware (to be implemented separately, extracts userId from token)
- HTTP client library (axios or native fetch) for Cluebase API calls
- ConfigService for Cluebase API URL and credentials

---

## Implementation Notes

1. **Cluebase API Integration**: Research Cluebase API documentation to understand:
   - Endpoint URL structure
   - Authentication requirements (if any)
   - Response format
   - Rate limiting considerations
   - How to filter by round and dollar values

2. **Clue Deduplication**: When checking for existing clues, match on:
   - category (exact match)
   - round (exact match)
   - value (exact match)
   - question (exact match)
   - answer (exact match)
   - dailyDouble (exact match)

3. **Transaction Management**: Use Prisma transaction to ensure atomicity:
   - Game creation
   - Clue creation (if needed)
   - GameClue creation
   - GameAudit creation
   - All succeed or all rollback

4. **Response Structure**: Response should include board state in a format that allows frontend to render the game board without making additional API calls for clue details.

5. **Final Jeopardy**: Do not create FinalJeopardy record during game creation. This will be created later when the game reaches the Final Jeopardy round.

